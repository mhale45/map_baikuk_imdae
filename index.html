<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f605c7b72dc7f3083f36483e55e2bc77&autoload=false"></script>
    <style>
        #map {
            width: 100%;
            height: 880px;
        }
        .textbox {
            position: absolute;
            top: 50px;
            left: 20px;
            background: rgba(0, 0, 0, 0.6);
            color: white; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            padding: 10px 10px;
            border-radius: 10px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            font-size: 16px;
            width: 250px;
            z-index: 1000; /* âœ… ì§€ë„ë³´ë‹¤ ìœ„ì— í‘œì‹œë˜ë„ë¡ ì„¤ì • */
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ë‹«í˜ */
        }
        /* ì—…ë°ì´íŠ¸ê¸°ë¡ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #toggleTextBox {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 5px 10px;
            background-color: #464646; /* íŒŒë€ìƒ‰ */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .info-window-one {
            font-size: 13px !important; /* ğŸ”¹ ê¸€ì í¬ê¸° ì„¤ì • */
            font-weight: 500 !important; /* ğŸ”¹ ê¸€ì êµµê²Œ ì„¤ì • */
            background: rgba(255, 255, 255, 1) !important;
            padding: 5px !important; /* ğŸ”¹ ë‚´ë¶€ ì—¬ë°± ì„¤ì • */
            max-width: 600px !important; /* ğŸ”¹ ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
            word-wrap: break-word !important; /* ğŸ”¹ ê¸´ ë‹¨ì–´ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì¤„ë°”ê¿ˆ */
            overflow-wrap: break-word !important; /* ğŸ”¹ ê³µë°±ì´ ì—†ì–´ë„ ê°•ì œ ì¤„ë°”ê¿ˆ */
            /* overflow-x: auto !important; ğŸ”¹ ê°€ë¡œ ìŠ¤í¬ë¡¤ */
            white-space: nowrap !important; /* ğŸ”¹ ìë™ ì¤„ë°”ê¿ˆ ë°©ì§€ (ê³µë°±ì´ ìˆì–´ë„ ì¤„ë°”ê¿ˆë˜ì§€ ì•ŠìŒ) */
            text-align: left !important; /* ğŸ”¹ í…ìŠ¤íŠ¸ ì •ë ¬ì„ ì™¼ìª½ìœ¼ë¡œ ì„¤ì • */
            pointer-events: none !important; /* í„°ì¹˜ ë° í´ë¦­ ë¹„í™œì„±í™” */
            border-radius: 5px;
            border: none !important; /* âœ… í…Œë‘ë¦¬ ì œê±° */
            box-shadow: none !important; /* âœ… ê·¸ë¦¼ì ì œê±° */
        }
        .info-window-one::after, .info-window-one::before{
            content: none !important; /* âœ… ì‚¼ê°í˜•ì„ ì™„ì „íˆ ì œê±° */
            display: none !important;
        }
        .info-window-one a, .info-window-many a {
            pointer-events: auto !important;  /* ğŸ”¹ ì œëª© ë§í¬ëŠ” í´ë¦­ ê°€ëŠ¥ */
        }
        .info-window-many {
            font-size: 14px !important; /* ğŸ”¹ ê¸€ì í¬ê¸° ì„¤ì • */
            font-weight: 500 !important; /* ğŸ”¹ ê¸€ì êµµê²Œ ì„¤ì • */
            background-color: white !important; /* ğŸ”¹ ë°°ê²½ ìƒ‰ìƒì„ í°ìƒ‰ìœ¼ë¡œ ì„¤ì • */
            padding: 5px !important; /* ğŸ”¹ ë‚´ë¶€ ì—¬ë°± ì„¤ì • */
            border-radius: 5px !important; /* ğŸ”¹ ë°•ìŠ¤ í…Œë‘ë¦¬ë¥¼ ë‘¥ê¸€ê²Œ ë§Œë“¦ */
            line-height: 2 !important; /* ğŸ”¹ ì¤„ ê°„ê²© ì¡°ì • */
            max-width: 600px !important; /* ğŸ”¹ ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
            max-height: 600px !important; /* ğŸ”¹ ìµœëŒ€ ë†’ì´ ì„¤ì • */
            white-space: nowrap !important; /* ğŸ”¹ ìë™ ì¤„ë°”ê¿ˆ 
            overflow-x: auto !important; /* ğŸ”¹ ê°€ë¡œ ìŠ¤í¬ë¡¤ ì œê±° */
            overflow-y: auto !important; /* ğŸ”¹ ë‚´ìš©ì´ ë§ìœ¼ë©´ ì„¸ë¡œ ìŠ¤í¬ë¡¤ ìƒì„± */                
            border: 3px solid black !important; /* ğŸ”¹ ë‘ê»˜ 3px, ê²€ì •ìƒ‰ í…Œë‘ë¦¬ */
            box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2) !important; /* ğŸ”¹ ê·¸ë¦¼ì ì¶”ê°€ */
        }
        .custom-overlay {
            position: absolute;
            bottom: 1px; /* âœ… ì˜¤ë²„ë ˆì´ ìœ„ì¹˜ ì¡°ì • */            
            background: rgba(255, 255, 255, 1);
            border-radius: 5px;
            font-size: 13px;
            white-space: nowrap;
            text-align: center;
            border: 1px solid black !important;
            user-select: text;
            cursor: pointer;
            box-shadow: none !important; /* âœ… ê·¸ë¦¼ì ì œê±° */                
            padding: 1px !important; /* ğŸ”¹ ë‚´ë¶€ ì—¬ë°± ì„¤ì • */
            font-weight: 500 !important; /* ğŸ”¹ ê¸€ì êµµê²Œ ì„¤ì • */
        }
        .custom-overlay::after {
            content: none !important; /* âœ… ì‚¼ê°í˜• ì œê±° */
            display: none !important;
            border: none !important; /* âœ… í…Œë‘ë¦¬ ì œê±° */
        }
        /* ğŸ“Œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #openInitialInfoWindows, #closeAllInfoWindows, #toggleSearch, #applyDepositFilter, #filterClear, #filterSearch{
            position: absolute; 
            right: 20px; 
            padding: 10px 15px; 
            border: none; 
            border-radius: 5px; 
            font-weight: bold; 
            cursor: pointer;
            width: auto;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        #changeMapBaikuk, #changeMapTotal, #changeMapNaver, #display-bugisa-all{
            position: absolute; 
            left: 20px; 
            padding: 8px 13px; 
            border: none; 
            border-radius: 5px; 
            font-weight: bold; 
            cursor: pointer;
            width: auto;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        #filter-container {
            position: absolute;
            top: 120px;
            right: 20px;
            width: 90px;
            flex-direction: column; /* ì„¸ë¡œ ë°°ì¹˜ */
            gap: 0px;  /* ğŸ”¹ ì…ë ¥ì°½ ì‚¬ì´ ê°„ê²© ì„¤ì • */
            background: white;
            padding: 4px;
            border-radius: 5px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }
        #filter-label {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
        }
        #minDepositInput, #maxDepositInput,
        #minRentInput, #maxRentInput,
        #minRightInput, #maxRightInput,
        #minAreaInput, #maxAreaInput,
        #minFloorInput, #maxFloorInput,
        #detailContents{
            padding: 4px;
            font-size: 14px;
            margin: 1px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        /* ğŸ“Œ "í•„í„° ì ìš©" ë²„íŠ¼ (íšŒìƒ‰) */
        #applyDepositFilter {
            bottom: 145px; 
            background-color: #696969;
            color: white;
            display: none;
        }
        /* ğŸ“Œ "í•„í„° ì´ˆê¸°í™”" ë²„íŠ¼ (íšŒìƒ‰) */
        #filterClear {
            bottom: 105px;
            right: 20px;
            background-color: #696969;
            color: white;
            display: none;
        }
        /* ğŸ“Œ "ë°±ì–µ" ë²„íŠ¼ (ë…¸ë€ìƒ‰) */
        #changeMapBaikuk {
            bottom: 20px; 
            left: 20px;
            background-color: #f2c130;
            color: black;
            font-size: 16px;
        }
        /* ğŸ“Œ "ì§„í–‰ì¤‘" (ë…¸ë€ìƒ‰) */
        #display-bugisa-all {
            bottom: 20px; 
            left: 85px; 
            font-size: 15px;
            background-color: #f2c130;
            color: black;
        }
        #progressCheckbox {
            transform: scale(1.5); /* âœ… ì²´í¬ë°•ìŠ¤ í¬ê¸° í™•ëŒ€ (1.5ë°°) */
            margin-left: 5px; /* ì²´í¬ë°•ìŠ¤ì™€ í…ìŠ¤íŠ¸ ê°„ ê°„ê²© */
            cursor: pointer; /* ë§ˆìš°ìŠ¤ ì»¤ì„œë¥¼ ì†ê°€ë½ ëª¨ì–‘ìœ¼ë¡œ ë³€ê²½ */
        }
        /* ğŸ“Œ "í†µí•©" ë²„íŠ¼ (ì˜¬ë¦¬ë¸Œ) */
        #changeMapTotal {
            bottom: 63px; 
            left: 20px;
            background-color: #92C340;
            color: black;
            font-size: 16px;
        }
        /* ğŸ“Œ "ê´‘ê³ " ë²„íŠ¼ (ë…¹ìƒ‰) */
        #changeMapNaver {
            bottom: 106px; 
            left: 20px;
            background-color: #03C75A;
            color: black;
            font-size: 16px;
        }
        /* ğŸ“Œ "í•„í„°ì°½" ë²„íŠ¼ (íŒŒë€ìƒ‰) */
        #filterSearch {
            bottom: 20px; 
            right: 120px;
            background-color: #007bff;
            color: white;
        }
        /* ğŸ“Œ "í…ìŠ¤íŠ¸ ì—´ê¸°" ë²„íŠ¼ (ì´ˆë¡ìƒ‰) */
        #openInitialInfoWindows {
            bottom: 60px;
            background-color: #4CAF50;
            color: white;
        }
        /* ğŸ“Œ "í…ìŠ¤íŠ¸ ë‹«ê¸°" ë²„íŠ¼ (ë¹¨ê°„ìƒ‰) */
        #closeAllInfoWindows {
            bottom: 20px; 
            background-color: #ff5555;
            color: white;
        }
    </style>
</head>
<body>
    <!-- ğŸ“Œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì°½ -->
    <div id="password-container" style="
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
        text-align: center;
        z-index: 1000;">
        <h3>ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
        <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="padding: 5px;">
        <button onclick="checkPassword()" style="padding: 5px; cursor: pointer;">í™•ì¸</button>
        <p id="errorMessage" style="color: red; display: none;">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!</p>
    </div>

    <!-- ğŸ“Œ ì§€ë„ ë° UI (ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ í‘œì‹œë¨) -->
    <div id="map-container" style="display: none;">
    <h2></h2>
    <div id="map"></div>
        <button id="toggleTextBox">ì—…ë°ì´íŠ¸ê¸°ë¡ ì—´ê¸°</button>
        <div class="textbox"></div>
        <div id="filter-container">
            <label id="filter-label">ë³´ì¦ê¸ˆ</label>
            <input type="number" id="minDepositInput" placeholder="ìµœì†Œ">
            <input type="number" id="maxDepositInput" placeholder="ìµœëŒ€">
            <label id="filter-label">ì›”ì„¸</label>
            <input type="number" id="minRentInput" placeholder="ìµœì†Œ">
            <input type="number" id="maxRentInput" placeholder="ìµœëŒ€">
            <label id="filter-label">ê¶Œë¦¬ê¸ˆ</label>
            <input type="number" id="minRightInput" placeholder="ìµœì†Œ">
            <input type="number" id="maxRightInput" placeholder="ìµœëŒ€">
            <label id="filter-label">ë©´ì </label>
            <input type="number" id="minAreaInput" placeholder="ìµœì†Œ">
            <input type="number" id="maxAreaInput" placeholder="ìµœëŒ€">
            <label id="filter-label">ì¸µ</label>
            <input type="number" id="minFloorInput" placeholder="ìµœì†Œ">
            <input type="number" id="maxFloorInput" placeholder="ìµœëŒ€">
            <label id="filter-label">ì„¸ë¶€ë‚´ìš©</label>
            <input type="text" id="detailContents" placeholder="">
        </div>
        <button id="filterClear">í•„í„° ì´ˆê¸°í™”</button>
        <button id="applyDepositFilter">í•„í„° ì ìš©</button>
        <button id="openInitialInfoWindows">í…ìŠ¤íŠ¸ ì—´ê¸°</button>
        <button id="closeAllInfoWindows">í…ìŠ¤íŠ¸ ë‹«ê¸°</button>
        <button id="filterSearch">í•„í„°ì°½</button>
        <button id="changeMapTotal">í†µí•©</button>
        <button id="changeMapBaikuk">ë°±ì–µ</button>
        <label id="display-bugisa-all">
            ì§„í–‰ì¤‘ <input type="checkbox" id="progressCheckbox" checked style="margin-left: 3px;">
        </label>
        <button id="changeMapNaver">ê´‘ê³ </button>
    </div>

</body>
</html>
<script>
     // âœ… "ì—…ë°ì´íŠ¸ê¸°ë¡" ë²„íŠ¼ í´ë¦­ ì‹œ í…ìŠ¤íŠ¸ë°•ìŠ¤ ì—´ê¸°/ë‹«ê¸°
     document.getElementById("toggleTextBox").addEventListener("click", function() {
            const textbox = document.querySelector(".textbox");
            if (textbox.style.display === "none" || textbox.style.display === "") {
                textbox.style.display = "block"; // í…ìŠ¤íŠ¸ë°•ìŠ¤ í‘œì‹œ
                this.textContent = "ì—…ë°ì´íŠ¸ê¸°ë¡ ë‹«ê¸°"; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            } else {
                textbox.style.display = "none"; // í…ìŠ¤íŠ¸ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
                this.textContent = "ì—…ë°ì´íŠ¸ê¸°ë¡ ì—´ê¸°"; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            }
        });

    async function getCellValue() {
        try {
            const sheetURL = "https://docs.google.com/spreadsheets/d/1f1urapy7S5buKKuHxgaVAc4ZbjndZvfCsiovAwwkB4g/gviz/tq?tqx=out:csv"; // âœ… ì˜¬ë°”ë¥¸ CSV URL
            const response = await fetch(sheetURL);

            if (!response.ok) throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);

            const text = await response.text();

            // âœ… CSV ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
            const rows = text.split("\n").map(row => row.split(","));

            // âœ… Aì—´ (ê° í–‰ì˜ ì²« ë²ˆì§¸ ê°’) ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í°ë”°ì˜´í‘œ ì œê±°)
            const columnAValues = rows
                .map(row => row[0]?.trim().replace(/"/g, "")) // ğŸ”¹ í°ë”°ì˜´í‘œ ì œê±°
                .filter(value => value); // ë¹ˆ ê°’ ì œê±°

            // âœ… ì¤„ë°”ê¿ˆ ìœ ì§€í•˜ì—¬ HTMLì— í‘œì‹œ
            const finalText = columnAValues.join("<br>");

            console.log("ğŸ“Œ ìµœì¢… ì¶œë ¥ ë°ì´í„°:", finalText);

            const textbox = document.querySelector(".textbox");
            if (textbox) {
                textbox.innerHTML = finalText;
            } else {
                console.error("âŒ 'textbox' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        } catch (error) {
            console.error("âŒ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
    }

    let map;
    let markers = [];
    let overlays = [];
    let infoWindows = [];
    let isOpenStates = [];
    let currentData = localStorage.getItem("currentData") || "df_bugisa.json";

    function checkPassword() {
        var correctPassword = "2834";
        var userInput = document.getElementById("passwordInput").value;
        var errorMessage = document.getElementById("errorMessage");

        if (userInput === correctPassword) {
            document.getElementById("password-container").style.display = "none";
            document.getElementById("map-container").style.display = "block";
            initMap();
        } else {
            errorMessage.style.display = "block";
        }
    }
    // âœ… í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œì—ë„ ì„ íƒí•œ ë°ì´í„° ìœ ì§€
    function setCurrentData(newData) {
        currentData = newData;
        localStorage.setItem("currentData", newData);
    }

    document.getElementById("passwordInput").focus();
    document.getElementById("passwordInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            checkPassword();
        }
    });

    function initMap() {
        kakao.maps.load(function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    let userLat = position.coords.latitude;
                    let userLng = position.coords.longitude;
                    let userPosition = new kakao.maps.LatLng(userLat, userLng);

                    loadMap(userPosition);
                }, function(error) {
                    console.error("âŒ í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸)ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.", error);
                    loadMap(new kakao.maps.LatLng(37.697248, 126.760244)); // ê¸°ë³¸ ìœ„ì¹˜
                });
            } else {
                console.error("âŒ Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
                loadMap(new kakao.maps.LatLng(37.697248, 126.760244)); // ê¸°ë³¸ ìœ„ì¹˜
            }
        });
    }

    function loadMap(centerPosition) {
        let container = document.getElementById('map');
        let options = { center: centerPosition, level: 3 };
        map = new kakao.maps.Map(container, options);
        
        loadMarkers(currentData);
    }

    function loadMarkers(jsonFile) {
        closeAllInfoWindows(); // ëª¨ë“  ì¸í¬ìœˆë„ìš° ë‹«ê¸°

        // let githubRawBaseURL = "https://raw.githubusercontent.com/mhale45/map_baikuk_imdae/master/";
        // let jsonURL = githubRawBaseURL + currentData + "?t=" + new Date().getTime();
        let jsonURL = currentData + "?t=" + new Date().getTime();

        fetch(jsonURL)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`âŒ JSON ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ (${response.status} ${response.statusText})`);
                }
                return response.json();
            })
            .then(data => {
                console.log("âœ… í•„í„° ì ìš© ì „ ë°ì´í„° ê°œìˆ˜:", data.length);

                // í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸°
                let minDeposit = parseInt(document.getElementById("minDepositInput").value) || 0;
                let maxDeposit = parseInt(document.getElementById("maxDepositInput").value) || 10000000000;
                let minRent = parseInt(document.getElementById("minRentInput").value) || 0;
                let maxRent = parseInt(document.getElementById("maxRentInput").value) || 10000000000;

                let filteredData = data.filter(row => {
                    let deposit = parseInt(row.ë³´ì¦ê¸ˆ) || 0;
                    let rent = parseInt(row.ì›”ì„¸) || 0;
                    return (
                        deposit >= minDeposit && deposit <= maxDeposit &&
                        rent >= minRent && rent <= maxRent
                    );
                });

                console.log("âœ… í•„í„° ì ìš© í›„ ë°ì´í„° ê°œìˆ˜:", filteredData.length);

                // âœ… ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
                clearMarkers();

                // âœ… í•„í„°ë§ëœ ë°ì´í„°ë¥¼ 'ëŒ€í‘œì£¼ì†Œ' ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™” í›„ ë§ˆì»¤ ì¶”ê°€
                let groupedData = groupByAddress(filteredData);
                addMarkers(groupedData);
            })
            .catch(error => {
                console.error('âŒ í•„í„° ì ìš© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert("âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•˜ì„¸ìš”.");
            });
    }

    function groupByAddress(data) {
        let grouped = {};

        data.forEach(row => {
            let key = row.ëŒ€í‘œì£¼ì†Œ;
            if (!grouped[key]) {
                grouped[key] = {
                    ëŒ€í‘œì£¼ì†Œ: row.ëŒ€í‘œì£¼ì†Œ,
                    ìœ„ë„: row.ìœ„ë„,
                    ê²½ë„: row.ê²½ë„,
                    ì§€ë„ë‚´ìš©: [],
                    ìƒìœ„ì‘ì—…: row.ìƒìœ„ì‘ì—…
                };
            }

            grouped[key].ì§€ë„ë‚´ìš©.push(row.ì§€ë„ë‚´ìš©);
        });

        return Object.values(grouped).map(entry => {
            entry.ì§€ë„ë‚´ìš© = formatGroupedContent(entry.ì§€ë„ë‚´ìš©);
            return entry;
        });
    }

    function formatGroupedContent(contents) {
        if (contents.length === 0) return "";

        let formatted = [contents[0]]; // ì²« ë²ˆì§¸ ì¤„ ì¶”ê°€

        for (let i = 1; i < contents.length; i++) {
            // âœ… HTML íƒœê·¸ë¥¼ ì œê±°í•˜ê³  ì¸µ ì •ë³´ ì¶”ì¶œ
            let prevFloor = contents[i - 1].replace(/<\/?[^>]+(>|$)/g, "").trim().match(/^(\d+F)/);
            let currFloor = contents[i].replace(/<\/?[^>]+(>|$)/g, "").trim().match(/^(\d+F)/);

            // âœ… ì¸µ ì •ë³´ê°€ ë‹¤ë¥´ë©´ í•œ ì¤„ ë„ìš°ê¸°
            if (prevFloor && currFloor && prevFloor[0] !== currFloor[0]) {
                formatted.push(""); // âœ… ì¤„ ë°”ê¿ˆ ì—†ì´ ë°°ì—´ì— ë¹ˆ ë¬¸ìì—´ ì¶”ê°€
            }

            formatted.push(contents[i]);
        }

        return formatted.join("<br>"); // âœ… í•œ ì¤„ë§Œ ë„ìš°ë„ë¡ ìœ ì§€
    }

    function addMarkers(data) {
        data.forEach((item, index) => {
            let position = new kakao.maps.LatLng(item.ìœ„ë„, item.ê²½ë„);
            
            let imageSize = new kakao.maps.Size(32, 32);
            let isMerged = item.ì§€ë„ë‚´ìš©.includes("<br>");

            // âœ… 'df_naver.json'ì´ ë¡œë“œë˜ì—ˆì„ ë•Œ info-window-oneì˜ ì´ë¯¸ì§€ ë³€ê²½
            let markerImageURL;
            
            console.log("í˜„ì¬ ë°ì´í„° íŒŒì¼:", currentData);
            console.log("ìƒìœ„ì‘ì—… ê°’:", item.ìƒìœ„ì‘ì—…, "íƒ€ì…:", typeof item.ìƒìœ„ì‘ì—…);
            console.log("ì§€ë„ë‚´ìš©:", item.ì§€ë„ë‚´ìš©);

            // âœ… 'df_naver.json'ì¸ ê²½ìš°, 'ìƒìœ„ì‘ì—…' ê°’ ì²´í¬
            if (
                isMerged &&
                currentData === "df_naver.json" && 
                (item.ìƒìœ„ì‘ì—… == 1) && 
                item.ì§€ë„ë‚´ìš© && item.ì§€ë„ë‚´ìš©.includes("ë°±ì–µ") // âœ… ì§€ë„ë‚´ìš©ì´ undefined/nullì´ ì•„ë‹ ë•Œë§Œ ê²€ì‚¬
            ) {
                markerImageURL = "https://raw.githubusercontent.com/mhale45/image/main/1-1.png";
            } else if (isMerged) {
                markerImageURL = "https://raw.githubusercontent.com/mhale45/image/main/5-1.png"; // âœ… ì—¬ëŸ¬ ì¤„ì¸ ê²½ìš° '5-1.png'
            } else if (currentData === "df_total.json") {
                markerImageURL = "https://raw.githubusercontent.com/mhale45/image/main/2-2.png"; // âœ… 'í†µí•©' ëª¨ë“œ
            } else if (currentData === "df_naver.json") {
                markerImageURL = "https://raw.githubusercontent.com/mhale45/image/main/2-1.png"; // âœ… 'ê´‘ê³ ' ëª¨ë“œ (ìƒìœ„ì‘ì—… 0ì¼ ë•Œ)
            } else {
                markerImageURL = "https://raw.githubusercontent.com/mhale45/image/main/2.png"; // âœ… 'ë°±ì–µ' ëª¨ë“œ
            }

            let markerImage = new kakao.maps.MarkerImage(markerImageURL, imageSize);

            let marker = new kakao.maps.Marker({
                position: position,
                image: markerImage,
                map: map
            });

            // ğŸ”¹ infoWindow ìŠ¤íƒ€ì¼ ì ìš©
            let infoWindowClass = isMerged ? "info-window-many" : "info-window-one";

            let infowindow = new kakao.maps.InfoWindow({
                content: `<div class="${infoWindowClass}" style="padding:5px;">${item.ì§€ë„ë‚´ìš©}</div>`
            });

            let overlayContent = `
                <div class="custom-overlay">
                    <span class="address-text" 
                        style="text-decoration: underline; cursor: pointer;"
                        data-address="${item.ëŒ€í‘œì£¼ì†Œ}">
                    ${item.ëŒ€í‘œì£¼ì†Œ}
                    <a href="https://new.land.naver.com/offices?ms=${item.ìœ„ë„},${item.ê²½ë„},19&a=SG:SMS:GJCG:APTHGJ:GM:TJ&b=B2&e=RETAIL&ad=true" 
                        target="_blank" 
                        style="vertical-align: middle;">
                        <img src="https://raw.githubusercontent.com/mhale45/image/main/naver_land_icon.png" 
                            alt="ë„¤ì´ë²„ ë¶€ë™ì‚°" 
                            style="width: 16px; height: 16px; vertical-align: middle; cursor: pointer;" />
                    </a>
                </div>
                `;
            let overlay = new kakao.maps.CustomOverlay({
                content: overlayContent,
                position: marker.getPosition(),
                xAnchor: 0.5,  // ğŸ”¹ ê°€ë¡œ ê¸°ì¤€ ê°€ìš´ë° ì •ë ¬
                yAnchor: 1.0   // ğŸ”¹ ì„¸ë¡œ ê¸°ì¤€ ì•„ë˜ìª½ (ë§ˆì»¤ ìœ„ì— ë¶™ê²Œ ë¨)
            });

            isOpenStates[index] = false; // ì´ˆê¸° ìƒíƒœëŠ” ë‹«í˜
            infoWindows[index] = infowindow; // âœ… infoWindows ë°°ì—´ì— ì €ì¥

            kakao.maps.event.addListener(marker, 'click', function () {
                if (isOpenStates[index]) {
                    infowindow.close();
                    overlay.setMap(null);
                } else {
                    infowindow.open(map, marker);
                    overlay.setMap(map);
                }
                isOpenStates[index] = !isOpenStates[index]; // ìƒíƒœ í† ê¸€
            });

            markers.push(marker);
            overlays.push(overlay);
        });
    }

    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null));
        overlays.forEach(overlay => overlay.setMap(null));
        markers = [];
        overlays = [];
        isOpenStates = [];
    }

    function closeAllInfoWindows() {
        markers.forEach((marker, index) => {
            isOpenStates[index] = false;  // ìƒíƒœë¥¼ ë‹«í˜(false)ìœ¼ë¡œ ë³€ê²½
            overlays[index].setMap(null); // ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
            infoWindows[index].close();   // infoWindow ë‹«ê¸°
        });
    }

    function openVisibleInfoWindows() {
        let bounds = map.getBounds(); // âœ… í˜„ì¬ í™”ë©´ ì˜ì—­ ê°€ì ¸ì˜¤ê¸°

        markers.forEach((marker, index) => {
            let markerPosition = marker.getPosition();
            let infoWindowContent = infoWindows[index].getContent();

            // âœ… í™”ë©´ ì•ˆì— ìˆëŠ” ë§ˆì»¤ + info-window-one ìŠ¤íƒ€ì¼ë§Œ ì˜¤í”ˆ
            if (bounds.contain(markerPosition) && infoWindowContent.includes('class="info-window-one"')) {
                infoWindows[index].open(map, marker);
                overlays[index].setMap(null);
                isOpenStates[index] = true; // ìƒíƒœë¥¼ ì—´ë¦¼ìœ¼ë¡œ ë³€ê²½
            }
        });
    }

    function applyFilters() {
        closeAllInfoWindows(); // ëª¨ë“  ì¸í¬ìœˆë„ìš° ë‹«ê¸°

        // let githubRawBaseURL = "https://raw.githubusercontent.com/mhale45/map_baikuk_imdae/master/";
        // let jsonURL = githubRawBaseURL + currentData + "?t=" + new Date().getTime();
        let jsonURL = currentData + "?t=" + new Date().getTime();


        fetch(jsonURL)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`âŒ JSON ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ (${response.status} ${response.statusText})`);
                }
                return response.json();
            })
            .then(data => {
                console.log("âœ… í•„í„° ì ìš© ì „ ë°ì´í„° ê°œìˆ˜:", data.length);

                // í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸°
                let minDeposit = parseInt(document.getElementById("minDepositInput").value) || 0;
                let maxDeposit = parseInt(document.getElementById("maxDepositInput").value) || 10000000000;
                let minRent = parseInt(document.getElementById("minRentInput").value) || 0;
                let maxRent = parseInt(document.getElementById("maxRentInput").value) || 10000000000;
                let minRight = parseInt(document.getElementById("minRightInput").value) || 0;
                let maxRight = parseInt(document.getElementById("maxRightInput").value) || 10000000000;
                let minArea = parseInt(document.getElementById("minAreaInput").value) || 0;
                let maxArea = parseInt(document.getElementById("maxAreaInput").value) || 10000000000;
                let minFloor = parseInt(document.getElementById("minFloorInput").value) || 0;
                let maxFloor = parseInt(document.getElementById("maxFloorInput").value) || 10000000000;
                let detail1 = document.getElementById("detailContents").value.trim();

                // âœ… í•„í„° ì ìš©: ëª¨ë“  ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ë°ì´í„°ë§Œ í•„í„°ë§
                let filteredData = data.filter(row => {
                    let deposit = parseInt(row.ë³´ì¦ê¸ˆ) || 0;
                    let rent = parseInt(row.ì›”ì„¸) || 0;
                    let right = parseInt(row.ê¶Œë¦¬ê¸ˆ) || 0;
                    let area = parseInt(row.ë©´ì ) || 0;
                    let floor = parseInt(row.ì¸µ) || 0;
                    let detailContent = row.ì„¸ë¶€ë‚´ìš© ? row.ì„¸ë¶€ë‚´ìš©.toString() : "";

                    let matchesDetail1 = detail1 === "" || detailContent.includes(detail1);

                    return (
                        deposit >= minDeposit && deposit <= maxDeposit &&
                        rent >= minRent && rent <= maxRent &&
                        right >= minRight && right <= maxRight &&
                        area >= minArea && area <= maxArea &&
                        floor >= minFloor && floor <= maxFloor &&
                        matchesDetail1
                    );
                });

                console.log("âœ… í•„í„° ì ìš© í›„ ë°ì´í„° ê°œìˆ˜:", filteredData.length);

                // âœ… ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
                clearMarkers();

                // âœ… í•„í„°ë§ëœ ë°ì´í„°ë¥¼ 'ëŒ€í‘œì£¼ì†Œ' ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™” í›„ ë§ˆì»¤ ì¶”ê°€
                let groupedData = groupByAddress(filteredData);
                addMarkers(groupedData);
            })
            .catch(error => {
                console.error('âŒ í•„í„° ì ìš© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert("âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•˜ì„¸ìš”.");
            });
    }




    // ğŸ“Œ 'í•„í„° ì ìš©' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.getElementById("applyDepositFilter").addEventListener("click", applyFilters);

    // ğŸ“Œ 'í…ìŠ¤íŠ¸ ì—´ê¸°' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.getElementById("openInitialInfoWindows").addEventListener("click", openVisibleInfoWindows);

    // ğŸ“Œ 'í…ìŠ¤íŠ¸ ë‹«ê¸°' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.getElementById("closeAllInfoWindows").addEventListener("click", closeAllInfoWindows);

    // ğŸ“Œ 'ë°±ì–µì§€ë„' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ (df_bugisa.json ë¶ˆëŸ¬ì˜¤ê¸°)
    document.getElementById("changeMapBaikuk").addEventListener("click", function () {
        closeAllInfoWindows(); // ëª¨ë“  ì¸í¬ìœˆë„ìš° ë‹«ê¸°
        let isChecked = document.getElementById("progressCheckbox").checked;
        currentData = isChecked ? "df_bugisa.json" : "df_bugisa_all.json"; // âœ… ì²´í¬ ìƒíƒœì— ë”°ë¼ ë³€ê²½
        setCurrentData(currentData); // âœ… ë¡œì»¬ ì €ì¥
        clearMarkers(); // âœ… ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
        loadMarkers(currentData);      // âœ… ì§€ë„ì— ìƒˆë¡œìš´ ë°ì´í„° ì ìš©
    });

    // ğŸ“Œ 'í†µí•©ì§€ë„' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ (df_total.json ë¶ˆëŸ¬ì˜¤ê¸°)
    document.getElementById("changeMapTotal").addEventListener("click", function () {
        closeAllInfoWindows(); // ëª¨ë“  ì¸í¬ìœˆë„ìš° ë‹«ê¸°
        currentData = "df_total.json"; // âœ… ìƒˆë¡œìš´ ë°ì´í„° ë³€ê²½
        setCurrentData(currentData); // âœ… ë¡œì»¬ ì €ì¥
        clearMarkers(); // âœ… ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
        loadMarkers(currentData);      // âœ… ì§€ë„ì— ìƒˆë¡œìš´ ë°ì´í„° ì ìš©
    });
    
    // ğŸ“Œ 'ê´‘ê³ ì§€ë„' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ (df_naver.json ë¶ˆëŸ¬ì˜¤ê¸°)
    document.getElementById("changeMapNaver").addEventListener("click", function () {
        closeAllInfoWindows(); // ëª¨ë“  ì¸í¬ìœˆë„ìš° ë‹«ê¸°
        currentData = "df_naver.json"; // âœ… ìƒˆë¡œìš´ ë°ì´í„° ë³€ê²½
        setCurrentData(currentData); // âœ… ë¡œì»¬ ì €ì¥
        clearMarkers(); // âœ… ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
        loadMarkers(currentData);      // âœ… ì§€ë„ì— ìƒˆë¡œìš´ ë°ì´í„° ì ìš©
    });

    // âœ… '.custom-overlay' í´ë¦­ ì‹œ ë™ì‘ ì¶”ê°€
    document.addEventListener("click", function (event) {
        if (event.target.classList.contains("address-text")) {
            const clickedAddress = event.target.getAttribute("data-address");

            const matchedItem = markers.find((marker, index) => {
                return overlays[index].getContent().includes(clickedAddress);
            });

            if (matchedItem) {
                const index = markers.indexOf(matchedItem);
                const lat = markers[index].getPosition().getLat();
                const lng = markers[index].getPosition().getLng();

                let searchURL = `https://map.naver.com/v5/search/${encodeURIComponent(clickedAddress)}`;

                window.open(searchURL, "_blank");
            }
        }
    });


    document.getElementById("filterSearch").addEventListener("click", function() {
        var filterContainer = document.getElementById("filter-container");
        var depositContainer = document.getElementById("applyDepositFilter");
        var filterButton = document.getElementById("filterClear");

        if (filterContainer.style.display === "none") {
            filterContainer.style.display = "flex";
            depositContainer.style.display = "block";
            filterButton.style.display = "block";
        } else {
            filterContainer.style.display = "none";
            depositContainer.style.display = "none";
            filterButton.style.display = "none";
        }
    });

    document.getElementById("applyDepositFilter").addEventListener("click", applyFilters);

    document.getElementById("filterClear").addEventListener("click", function() {
        // ğŸ“Œ ì…ë ¥ê°’ ì´ˆê¸°í™”
        document.getElementById("minDepositInput").value = "";
        document.getElementById("maxDepositInput").value = "";
        document.getElementById("minRentInput").value = "";
        document.getElementById("maxRentInput").value = "";
        document.getElementById("minRightInput").value = "";
        document.getElementById("maxRightInput").value = "";
        document.getElementById("minAreaInput").value = "";
        document.getElementById("maxAreaInput").value = "";
        document.getElementById("minFloorInput").value = "";
        document.getElementById("maxFloorInput").value = "";
        document.getElementById("detailContents").value = "";
    });

    // âœ… ì´ˆê¸° ì§€ë„ ë¡œë“œ
    window.onload = function() {
        getCellValue();
        let savedData = localStorage.getItem("currentData") || "df_bugisa.json";
        setCurrentData("df_bugisa.json");
        initMap();
    };
</script>


